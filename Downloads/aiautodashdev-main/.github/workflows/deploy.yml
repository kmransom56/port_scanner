name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
      version:
        description: 'Version to deploy (leave empty for latest)'
        required: false
        type: string

  push:
    branches:
      - main
    paths:
      - 'main.py'
      - 'requirements.txt'
      - 'Dockerfile'
      - 'templates/**'
      - 'static/**'

jobs:
  deploy:
    name: Deploy to ${{ inputs.environment || 'production' }}
    runs-on: ubuntu-latest
    environment:
      name: ${{ inputs.environment || 'production' }}
      url: http://100.123.10.72:5902

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: Add SSH known hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H 100.123.10.72 >> ~/.ssh/known_hosts

    - name: Deploy to server
      env:
        DEPLOY_HOST: 100.123.10.72
        DEPLOY_USER: keith
      run: |
        echo "ðŸš€ Deploying AIAutoDash to ${{ inputs.environment || 'production' }}"

        # Copy files to server
        ssh $DEPLOY_USER@$DEPLOY_HOST "mkdir -p /tmp/aiautodash-deploy"
        scp -r ./* $DEPLOY_USER@$DEPLOY_HOST:/tmp/aiautodash-deploy/

        # Execute deployment commands
        ssh $DEPLOY_USER@$DEPLOY_HOST << 'EOF'
          set -e

          echo "ðŸ“¦ Backing up current deployment..."
          sudo mkdir -p /opt/backups/aiautodash
          sudo tar -czf /opt/backups/aiautodash/backup-$(date +%Y%m%d-%H%M%S).tar.gz \
            -C /home/keith/Downloads aiautodashdev-main || true

          echo "ðŸ”„ Updating application files..."
          sudo cp -r /tmp/aiautodash-deploy/* /home/keith/Downloads/aiautodashdev-main/

          echo "ðŸ³ Rebuilding Docker container..."
          cd /home/keith/chat-copilot
          docker compose build aiautodash

          echo "â™»ï¸ Restarting container..."
          docker compose up -d --force-recreate aiautodash

          echo "â³ Waiting for service to start..."
          sleep 15

          echo "ðŸ¥ Health check..."
          curl -f http://localhost:5902/health || exit 1

          echo "ðŸ§¹ Cleaning up..."
          rm -rf /tmp/aiautodash-deploy

          echo "âœ… Deployment complete!"
EOF

    - name: Verify deployment
      run: |
        echo "ðŸ” Verifying deployment..."

        # Test health endpoint
        curl -f http://100.123.10.72:5902/health

        # Test API endpoints
        curl -f http://100.123.10.72:5902/registry
        curl -f http://100.123.10.72:5902/api/stats
        curl -f http://100.123.10.72:5902/api/integrations

        echo "âœ… Deployment verified successfully!"

    - name: Rollback on failure
      if: failure()
      env:
        DEPLOY_HOST: 100.123.10.72
        DEPLOY_USER: keith
      run: |
        echo "âŒ Deployment failed, initiating rollback..."

        ssh $DEPLOY_USER@$DEPLOY_HOST << 'EOF'
          echo "ðŸ”„ Restoring from backup..."
          LATEST_BACKUP=$(ls -t /opt/backups/aiautodash/backup-*.tar.gz | head -1)

          if [ -n "$LATEST_BACKUP" ]; then
            sudo tar -xzf "$LATEST_BACKUP" -C /home/keith/Downloads/

            cd /home/keith/chat-copilot
            docker compose up -d --force-recreate aiautodash

            echo "âœ… Rollback complete"
          else
            echo "âš ï¸ No backup found for rollback"
          fi
EOF

    - name: Send deployment notification
      if: always()
      uses: actions/github-script@v7
      with:
        script: |
          const status = '${{ job.status }}';
          const emoji = status === 'success' ? 'âœ…' : 'âŒ';
          const environment = '${{ inputs.environment || 'production' }}';

          github.rest.repos.createCommitComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            commit_sha: context.sha,
            body: `${emoji} Deployment to **${environment}** ${status}\n\nWorkflow: [${context.workflow}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`
          });
